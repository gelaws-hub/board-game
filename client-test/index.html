<!DOCTYPE html>
<html>

<head>
    <title>Minuman Game Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
            color: #333;
        }

        input[type="text"],
        button {
            margin-bottom: 10px;
            padding: 10px 12px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            font-size: 1rem;
        }

        button {
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        pre {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 20px;
            border: 1px solid #dee2e6;
        }

        h1,
        h3 {
            color: #343a40;
            margin-bottom: 15px;
        }

        /* Chat Container Styling */
        #chatContainer {
            border: 1px solid #adb5bd;
            padding: 15px;
            margin-top: 20px;
            height: 300px;
            /* Fixed height */
            overflow-y: auto;
            /* Scrollable */
            background-color: #ffffff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #messagesList {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #messagesList li {
            padding: 8px 0;
            border-bottom: 1px dashed #e9ecef;
            font-size: 0.95rem;
            color: #495057;
        }

        #messagesList li:last-child {
            border-bottom: none;
        }

        .message-timestamp {
            font-size: 0.8em;
            color: #6c757d;
            margin-right: 5px;
        }

        .event-type {
            font-weight: bold;
            color: #007bff;
            /* Example color for event type */
        }

        .heartbeat-message {
            color: #28a745;
            /* Green for heartbeats */
        }
    </style>
</head>

<body>
    <h1>Minuman Game (Test UI)</h1>

    <button onclick="createGame()">Create Game</button><br><br>
    <input type="text" id="gameIdInput" placeholder="Enter Game ID" />
    <input type="text" id="usernameInput" placeholder="Username" />
    <button onclick="joinGame()">Join Game</button><br><br>
    <button onclick="startGame()">Start Game</button><br><br>
    <button onclick="checkStatus()">Check Game Status</button>

    <h3>API Call Output:</h3>
    <pre id="output"></pre>

    <h3>SignalR Messages:</h3>
    <div id="chatContainer">
        <ul id="messagesList">
        </ul>
    </div>

    <script>
        const apiBaseGame = 'http://localhost:5037/game';
        let currentGameId = "";
        let connection;
        const messagesList = document.getElementById("messagesList");

        // Function to add messages to the chat container
        function addMessageToChat(eventType, data, isHeartbeat = false) {
            const li = document.createElement("li");
            const timestamp = new Date().toLocaleTimeString();
            let dataString = typeof data === 'string' ? data : JSON.stringify(data, null, 2);

            li.innerHTML = `<span class="message-timestamp">[${timestamp}]</span> <span class="event-type">${eventType}:</span> ${dataString}`;
            if (isHeartbeat) {
                li.classList.add('heartbeat-message'); // Add class for styling
            }
            messagesList.appendChild(li);
            messagesList.scrollTop = messagesList.scrollHeight; // Scroll to the bottom
        }

        async function setupConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("http://localhost:5037/gamehub") // Ensure this URL/port is correct!
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information) // Keep this for debugging!
                .build();

            // Client-side listeners for messages from the hub
            connection.on("Heartbeat", (message) => { // NEW HEARTBEAT LISTENER
                console.log("Heartbeat:", message);
                addMessageToChat("Heartbeat", message, true); // Pass true for heartbeat styling
            });

            connection.on("GameStateUpdated", (game) => {
                console.log("Game state updated:", game);
                addMessageToChat("GameStateUpdated", game);
            });

            connection.on("PlayerJoined", (username) => {
                console.log("Player joined:", username);
                addMessageToChat("PlayerJoined", username);
            });

            // ADDED THESE LISTENERS (from previous suggestions)
            connection.on("AvailableGamesUpdated", (games) => {
                console.log("Available games updated:", games);
                addMessageToChat("AvailableGamesUpdated", games);
            });

            connection.on("Error", (message) => {
                console.error("Server Error:", message);
                addMessageToChat("Server Error", message);
            });

            connection.on("GameStarted", (game) => {
                console.log("Game started:", game);
                addMessageToChat("GameStarted", game);
            });

            connection.on("CardDrawn", (playerId, card) => {
                console.log(`Card drawn by ${playerId}:`, card);
                addMessageToChat("CardDrawn", { playerId, card });
            });
            // END ADDED LISTENERS

            // Handle reconnection attempts
            connection.onreconnecting(error => {
                console.warn("SignalR is reconnecting...", error);
                addMessageToChat("Reconnecting", { error: error.message });
            });

            connection.onreconnected(connectionId => {
                console.log(`SignalR reconnected. Connection ID: ${connectionId}`);
                addMessageToChat("Reconnected", { connectionId: connectionId });
            });

            try {
                await connection.start();
                console.log("✅ SignalR connected successfully.");
                addMessageToChat("Connected", { connectionId: connection.connectionId });

                // Optional: Immediately broadcast game list when connected
                // await connection.invoke("BroadcastGameList");
                // console.log("Invoked BroadcastGameList on hub.");

            } catch (err) {
                console.error("❌ SignalR connection error:", err);
                addMessageToChat("Connection Error", { error: err.message });
                setTimeout(() => setupConnection(), 5000); // Attempt to reconnect after 5 seconds on initial failure
            }
        }

        async function createGame() {
            try {
                const res = await fetch(`${apiBaseGame}/create`, { method: "POST" });
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                currentGameId = data.gameId;
                document.getElementById("gameIdInput").value = currentGameId;
                showOutput(data);
                addMessageToChat("API: Game Created", data);
            } catch (error) {
                console.error("Error creating game:", error);
                showOutput({ error: "Failed to create game", details: error.message });
                addMessageToChat("API Error: Create Game", { error: error.message });
            }
        }

        async function joinGame() {
            const gameId = document.getElementById("gameIdInput").value;
            const username = document.getElementById("usernameInput").value;
            if (!gameId || !username) {
                alert("Please enter a Game ID and Username.");
                return;
            }
            try {
                const res = await fetch(`${apiBaseGame}/${gameId}/join?username=${encodeURIComponent(username)}`, {
                    method: "POST"
                });
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                showOutput(data);
                addMessageToChat("API: Player Joined", data);

                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    await connection.invoke("JoinGame", gameId, username); // Corrected hub method name
                    console.log(`Invoked 'JoinGame' hub method for game: ${gameId}, username: ${username}`);
                    addMessageToChat("Hub Invoke: JoinGame", { gameId: gameId, username: username });
                }
            } catch (error) {
                console.error("Error joining game:", error);
                showOutput({ error: "Failed to join game", details: error.message });
                addMessageToChat("API Error: Join Game", { error: error.message });
            }
        }

        async function startGame() {
            const gameId = document.getElementById("gameIdInput").value;
            if (!gameId) {
                alert("Please enter a Game ID.");
                return;
            }
            // For testing the heartbeat, you can keep this as an API call
            // but remember your API controller needs to use IHubContext to broadcast
            // 'GameStarted' and 'GameStateUpdated' messages from the server side.
            try {
                const res = await fetch(`${apiBaseGame}/${gameId}/start`, { method: "POST" });
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                showOutput(data);
                addMessageToChat("API: Game Started", data);
            } catch (error) {
                console.error("Error starting game:", error);
                showOutput({ error: "Failed to start game", details: error.message });
                addMessageToChat("API Error: Start Game", { error: error.message });
            }
        }

        async function checkStatus() {
            const gameId = document.getElementById("gameIdInput").value;
            if (!gameId) {
                alert("Please enter a Game ID.");
                return;
            }
            try {
                const res = await fetch(`${apiBaseGame}/status/${gameId}`);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                showOutput(data);
                addMessageToChat("API: Game Status", data);
            } catch (error) {
                console.error("Error checking status:", error);
                showOutput({ error: "Failed to check status", details: error.message });
                addMessageToChat("API Error: Check Status", { error: error.message });
            }
        }

        function showOutput(data) {
            document.getElementById("output").textContent = JSON.stringify(data, null, 2);
        }

        setupConnection(); // Initialize SignalR connection on page load
    </script>
</body>

</html>